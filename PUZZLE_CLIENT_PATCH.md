# Puzzle Client Patch

This file provides a patched version of the auto-generated Puzzle GraphQL client to support:
- Cookie-based authentication
- WebSocket subscriptions with websockets 15.x

## Problem

The auto-generated client from `ariadne-codegen` doesn't support:
1. Cookie-based authentication (cookies are not persisted between requests)
2. WebSocket connections with websockets 15.x (API changes in the library)

## Solution

Since the `puzzle/` directory is auto-generated by `ariadne-codegen`, we cannot modify it directly. Instead, we created `puzzle_client_patched.py` which extends the generated `Client` class with the necessary patches.

## Usage

Instead of importing from `puzzle.client`:

```python
from puzzle.client import Client
client = Client(url="...", ws_url="...")
```

Import from `puzzle_client_patched`:

```python
from puzzle_client_patched import PuzzleClient
client = PuzzleClient(url="...", ws_url="...")
```

## What the patch does

### 1. Cookie Persistence

Creates an `httpx.AsyncClient` with a cookie jar enabled:

```python
http_client = httpx.AsyncClient(
    headers=headers,
    cookies=httpx.Cookies()  # Enable cookie jar
)
```

### 2. Cookie Forwarding to WebSocket

Extracts cookies from the HTTP client and adds them to WebSocket connection headers:

```python
cookie_header = "; ".join([
    f"{cookie.name}={cookie.value}"
    for cookie in self.http_client.cookies.jar
])
if cookie_header:
    headers["Cookie"] = cookie_header
```

### 3. WebSocket 15.x Compatibility

Uses `additional_headers` instead of `extra_headers` for websockets 15.x:

```python
merged_kwargs = {
    "additional_headers": headers
}
async with ws_connect(
    self.ws_url,
    subprotocols=[Subprotocol(GRAPHQL_TRANSPORT_WS)],
    **merged_kwargs,
) as websocket:
    # ...
```

## Regenerating the Client

When you need to regenerate the Puzzle client after schema changes:

```bash
rm -rf puzzle
uv run ariadne-codegen
```

The patch in `puzzle_client_patched.py` will continue to work as it only extends the generated client.

## Example

See `main.py` for a complete example of using the patched client with login and subscriptions.
